"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = define;

var _property = _interopRequireDefault(require("./property"));

var _render = _interopRequireDefault(require("./render"));

var cache = _interopRequireWildcard(require("./cache"));

var _utils = require("./utils");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === "object" || typeof call === "function")) { return call; } return _assertThisInitialized(self); }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }

function _wrapNativeSuper(Class) { var _cache = typeof Map === "function" ? new Map() : undefined; _wrapNativeSuper = function _wrapNativeSuper(Class) { if (Class === null || !_isNativeFunction(Class)) return Class; if (typeof Class !== "function") { throw new TypeError("Super expression must either be null or a function"); } if (typeof _cache !== "undefined") { if (_cache.has(Class)) return _cache.get(Class); _cache.set(Class, Wrapper); } function Wrapper() { return _construct(Class, arguments, _getPrototypeOf(this).constructor); } Wrapper.prototype = Object.create(Class.prototype, { constructor: { value: Wrapper, enumerable: false, writable: true, configurable: true } }); return _setPrototypeOf(Wrapper, Class); }; return _wrapNativeSuper(Class); }

function isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }

function _construct(Parent, args, Class) { if (isNativeReflectConstruct()) { _construct = Reflect.construct; } else { _construct = function _construct(Parent, args, Class) { var a = [null]; a.push.apply(a, args); var Constructor = Function.bind.apply(Parent, a); var instance = new Constructor(); if (Class) _setPrototypeOf(instance, Class.prototype); return instance; }; } return _construct.apply(null, arguments); }

function _isNativeFunction(fn) { return Function.toString.call(fn).indexOf("[native code]") !== -1; }

function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }

function _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

/* istanbul ignore next */
try {
  process.env.NODE_ENV;
} catch (e) {
  var process = {
    env: {
      NODE_ENV: 'production'
    }
  };
} // eslint-disable-line


function dispatchInvalidate(host) {
  (0, _utils.dispatch)(host, '@invalidate', {
    bubbles: true,
    composed: true
  });
}

var defaultMethod = function defaultMethod(host, value) {
  return value;
};

function compile(Hybrid, hybrids) {
  Hybrid.hybrids = hybrids;
  Hybrid.connects = [];
  Object.keys(hybrids).forEach(function (key) {
    var value = hybrids[key];

    var type = _typeof(value);

    var config;

    if (type === 'function') {
      config = key === 'render' ? (0, _render.default)(value) : {
        get: value
      };
    } else if (value === null || type !== 'object' || type === 'object' && !value.get && !value.set && !value.connect) {
      config = (0, _property.default)(value);
    } else {
      config = {
        get: value.get || defaultMethod,
        set: value.set || !value.get && defaultMethod || undefined,
        connect: value.connect
      };
    }

    Object.defineProperty(Hybrid.prototype, key, {
      get: function get() {
        return cache.get(this, key, config.get);
      },
      set: config.set && function set(newValue) {
        var _this = this;

        cache.set(this, key, config.set, newValue, function () {
          return dispatchInvalidate(_this);
        });
      },
      enumerable: true,
      configurable: process.env.NODE_ENV !== 'production'
    });

    if (config.connect) {
      Hybrid.connects.push(function (host) {
        return config.connect(host, key, function () {
          var clearCache = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;
          if (clearCache) cache.invalidate(host, key);
          dispatchInvalidate(host);
        });
      });
    }
  });
}

var update;
/* istanbul ignore else */

if (process.env.NODE_ENV !== 'production') {
  var walkInShadow = function walkInShadow(node, fn) {
    fn(node);
    Array.from(node.children).forEach(function (el) {
      return walkInShadow(el, fn);
    });

    if (node.shadowRoot) {
      Array.from(node.shadowRoot.children).forEach(function (el) {
        return walkInShadow(el, fn);
      });
    }
  };

  var updateQueue = new Map();

  update = function update(Hybrid, lastHybrids) {
    if (!updateQueue.size) {
      Promise.resolve().then(function () {
        walkInShadow(document.body, function (node) {
          if (updateQueue.has(node.constructor)) {
            var hybrids = updateQueue.get(node.constructor);
            node.disconnectedCallback();
            Object.keys(node.constructor.hybrids).forEach(function (key) {
              cache.invalidate(node, key, node[key] === hybrids[key]);
            });
            node.connectedCallback();
            dispatchInvalidate(node);
          }
        });
        updateQueue.clear();
      });
    }

    updateQueue.set(Hybrid, lastHybrids);
  };
}

var connects = new WeakMap();

function defineElement(tagName, hybridsOrConstructor) {
  var type = _typeof(hybridsOrConstructor);

  if (type !== 'object' && type !== 'function') {
    throw TypeError("Second argument must be an object or a function: ".concat(type));
  }

  var CustomElement = window.customElements.get(tagName);

  if (type === 'function') {
    if (CustomElement !== hybridsOrConstructor) {
      return window.customElements.define(tagName, hybridsOrConstructor);
    }

    return CustomElement;
  }

  if (CustomElement) {
    if (CustomElement.hybrids === hybridsOrConstructor) {
      return CustomElement;
    }

    if (process.env.NODE_ENV !== 'production' && CustomElement.hybrids) {
      Object.keys(CustomElement.hybrids).forEach(function (key) {
        delete CustomElement.prototype[key];
      });
      var lastHybrids = CustomElement.hybrids;
      compile(CustomElement, hybridsOrConstructor);
      update(CustomElement, lastHybrids);
      return CustomElement;
    }

    throw Error("Element '".concat(tagName, "' already defined"));
  }

  var Hybrid =
  /*#__PURE__*/
  function (_HTMLElement) {
    _inherits(Hybrid, _HTMLElement);

    function Hybrid() {
      _classCallCheck(this, Hybrid);

      return _possibleConstructorReturn(this, _getPrototypeOf(Hybrid).apply(this, arguments));
    }

    _createClass(Hybrid, [{
      key: "connectedCallback",
      value: function connectedCallback() {
        var _this2 = this;

        var list = this.constructor.connects.reduce(function (acc, fn) {
          var result = fn(_this2);
          if (result) acc.add(result);
          return acc;
        }, new Set());
        connects.set(this, list);
        dispatchInvalidate(this);
      }
    }, {
      key: "disconnectedCallback",
      value: function disconnectedCallback() {
        var list = connects.get(this);
        list.forEach(function (fn) {
          return fn();
        });
      }
    }], [{
      key: "name",
      get: function get() {
        return tagName;
      }
    }]);

    return Hybrid;
  }(_wrapNativeSuper(HTMLElement));

  compile(Hybrid, hybridsOrConstructor);
  customElements.define(tagName, Hybrid);
  return Hybrid;
}

function defineMap(elements) {
  return Object.keys(elements).reduce(function (acc, key) {
    var tagName = (0, _utils.pascalToDash)(key);
    acc[key] = defineElement(tagName, elements[key]);
    return acc;
  }, {});
}

function define() {
  if (_typeof(arguments.length <= 0 ? undefined : arguments[0]) === 'object') {
    return defineMap(arguments.length <= 0 ? undefined : arguments[0]);
  }

  return defineElement.apply(void 0, arguments);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9kZWZpbmUuanMiXSwibmFtZXMiOlsicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwiZSIsImRpc3BhdGNoSW52YWxpZGF0ZSIsImhvc3QiLCJidWJibGVzIiwiY29tcG9zZWQiLCJkZWZhdWx0TWV0aG9kIiwidmFsdWUiLCJjb21waWxlIiwiSHlicmlkIiwiaHlicmlkcyIsImNvbm5lY3RzIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrZXkiLCJ0eXBlIiwiY29uZmlnIiwiZ2V0Iiwic2V0IiwiY29ubmVjdCIsInVuZGVmaW5lZCIsImRlZmluZVByb3BlcnR5IiwicHJvdG90eXBlIiwiY2FjaGUiLCJuZXdWYWx1ZSIsImVudW1lcmFibGUiLCJjb25maWd1cmFibGUiLCJwdXNoIiwiY2xlYXJDYWNoZSIsImludmFsaWRhdGUiLCJ1cGRhdGUiLCJ3YWxrSW5TaGFkb3ciLCJub2RlIiwiZm4iLCJBcnJheSIsImZyb20iLCJjaGlsZHJlbiIsImVsIiwic2hhZG93Um9vdCIsInVwZGF0ZVF1ZXVlIiwiTWFwIiwibGFzdEh5YnJpZHMiLCJzaXplIiwiUHJvbWlzZSIsInJlc29sdmUiLCJ0aGVuIiwiZG9jdW1lbnQiLCJib2R5IiwiaGFzIiwiY29uc3RydWN0b3IiLCJkaXNjb25uZWN0ZWRDYWxsYmFjayIsImNvbm5lY3RlZENhbGxiYWNrIiwiY2xlYXIiLCJXZWFrTWFwIiwiZGVmaW5lRWxlbWVudCIsInRhZ05hbWUiLCJoeWJyaWRzT3JDb25zdHJ1Y3RvciIsIlR5cGVFcnJvciIsIkN1c3RvbUVsZW1lbnQiLCJ3aW5kb3ciLCJjdXN0b21FbGVtZW50cyIsImRlZmluZSIsIkVycm9yIiwibGlzdCIsInJlZHVjZSIsImFjYyIsInJlc3VsdCIsImFkZCIsIlNldCIsIkhUTUxFbGVtZW50IiwiZGVmaW5lTWFwIiwiZWxlbWVudHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7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QUFaLEVBQXNCUCxNQUF0QixDQUE2QixVQUFDQyxHQUFELEVBQU1uRCxHQUFOLEVBQWM7QUFDaEQsUUFBTXlDLE9BQU8sR0FBRyx5QkFBYXpDLEdBQWIsQ0FBaEI7QUFDQW1ELElBQUFBLEdBQUcsQ0FBQ25ELEdBQUQsQ0FBSCxHQUFXd0MsYUFBYSxDQUFDQyxPQUFELEVBQVVnQixRQUFRLENBQUN6RCxHQUFELENBQWxCLENBQXhCO0FBRUEsV0FBT21ELEdBQVA7QUFDRCxHQUxNLEVBS0osRUFMSSxDQUFQO0FBTUQ7O0FBRWMsU0FBU0osTUFBVCxHQUF5QjtBQUN0QyxNQUFJLDhEQUFtQixRQUF2QixFQUFpQztBQUMvQixXQUFPUyxTQUFTLGtEQUFoQjtBQUNEOztBQUVELFNBQU9oQixhQUFhLE1BQWIsbUJBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwcm9wZXJ0eSBmcm9tICcuL3Byb3BlcnR5JztcbmltcG9ydCByZW5kZXIgZnJvbSAnLi9yZW5kZXInO1xuXG5pbXBvcnQgKiBhcyBjYWNoZSBmcm9tICcuL2NhY2hlJztcbmltcG9ydCB7IGRpc3BhdGNoLCBwYXNjYWxUb0Rhc2ggfSBmcm9tICcuL3V0aWxzJztcblxuLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbnRyeSB7IHByb2Nlc3MuZW52Lk5PREVfRU5WIH0gY2F0Y2goZSkgeyB2YXIgcHJvY2VzcyA9IHsgZW52OiB7IE5PREVfRU5WOiAncHJvZHVjdGlvbicgfSB9OyB9IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcblxuZnVuY3Rpb24gZGlzcGF0Y2hJbnZhbGlkYXRlKGhvc3QpIHtcbiAgZGlzcGF0Y2goaG9zdCwgJ0BpbnZhbGlkYXRlJywgeyBidWJibGVzOiB0cnVlLCBjb21wb3NlZDogdHJ1ZSB9KTtcbn1cblxuY29uc3QgZGVmYXVsdE1ldGhvZCA9IChob3N0LCB2YWx1ZSkgPT4gdmFsdWU7XG5cbmZ1bmN0aW9uIGNvbXBpbGUoSHlicmlkLCBoeWJyaWRzKSB7XG4gIEh5YnJpZC5oeWJyaWRzID0gaHlicmlkcztcbiAgSHlicmlkLmNvbm5lY3RzID0gW107XG5cbiAgT2JqZWN0LmtleXMoaHlicmlkcykuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgY29uc3QgdmFsdWUgPSBoeWJyaWRzW2tleV07XG4gICAgY29uc3QgdHlwZSA9IHR5cGVvZiB2YWx1ZTtcblxuICAgIGxldCBjb25maWc7XG5cbiAgICBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgY29uZmlnID0ga2V5ID09PSAncmVuZGVyJyA/IHJlbmRlcih2YWx1ZSkgOiB7IGdldDogdmFsdWUgfTtcbiAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBudWxsIHx8IHR5cGUgIT09ICdvYmplY3QnIHx8ICh0eXBlID09PSAnb2JqZWN0JyAmJiAhdmFsdWUuZ2V0ICYmICF2YWx1ZS5zZXQgJiYgIXZhbHVlLmNvbm5lY3QpKSB7XG4gICAgICBjb25maWcgPSBwcm9wZXJ0eSh2YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbmZpZyA9IHtcbiAgICAgICAgZ2V0OiB2YWx1ZS5nZXQgfHwgZGVmYXVsdE1ldGhvZCxcbiAgICAgICAgc2V0OiB2YWx1ZS5zZXQgfHwgKCF2YWx1ZS5nZXQgJiYgZGVmYXVsdE1ldGhvZCkgfHwgdW5kZWZpbmVkLFxuICAgICAgICBjb25uZWN0OiB2YWx1ZS5jb25uZWN0LFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoSHlicmlkLnByb3RvdHlwZSwga2V5LCB7XG4gICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHtcbiAgICAgICAgcmV0dXJuIGNhY2hlLmdldCh0aGlzLCBrZXksIGNvbmZpZy5nZXQpO1xuICAgICAgfSxcbiAgICAgIHNldDogY29uZmlnLnNldCAmJiBmdW5jdGlvbiBzZXQobmV3VmFsdWUpIHtcbiAgICAgICAgY2FjaGUuc2V0KHRoaXMsIGtleSwgY29uZmlnLnNldCwgbmV3VmFsdWUsICgpID0+IGRpc3BhdGNoSW52YWxpZGF0ZSh0aGlzKSk7XG4gICAgICB9LFxuICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgIGNvbmZpZ3VyYWJsZTogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyxcbiAgICB9KTtcblxuICAgIGlmIChjb25maWcuY29ubmVjdCkge1xuICAgICAgSHlicmlkLmNvbm5lY3RzLnB1c2goaG9zdCA9PiBjb25maWcuY29ubmVjdChob3N0LCBrZXksIChjbGVhckNhY2hlID0gdHJ1ZSkgPT4ge1xuICAgICAgICBpZiAoY2xlYXJDYWNoZSkgY2FjaGUuaW52YWxpZGF0ZShob3N0LCBrZXkpO1xuICAgICAgICBkaXNwYXRjaEludmFsaWRhdGUoaG9zdCk7XG4gICAgICB9KSk7XG4gICAgfVxuICB9KTtcbn1cblxubGV0IHVwZGF0ZTtcbi8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovXG5pZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykge1xuICBjb25zdCB3YWxrSW5TaGFkb3cgPSAobm9kZSwgZm4pID0+IHtcbiAgICBmbihub2RlKTtcblxuICAgIEFycmF5LmZyb20obm9kZS5jaGlsZHJlbilcbiAgICAgIC5mb3JFYWNoKGVsID0+IHdhbGtJblNoYWRvdyhlbCwgZm4pKTtcblxuICAgIGlmIChub2RlLnNoYWRvd1Jvb3QpIHtcbiAgICAgIEFycmF5LmZyb20obm9kZS5zaGFkb3dSb290LmNoaWxkcmVuKVxuICAgICAgICAuZm9yRWFjaChlbCA9PiB3YWxrSW5TaGFkb3coZWwsIGZuKSk7XG4gICAgfVxuICB9O1xuXG4gIGNvbnN0IHVwZGF0ZVF1ZXVlID0gbmV3IE1hcCgpO1xuICB1cGRhdGUgPSAoSHlicmlkLCBsYXN0SHlicmlkcykgPT4ge1xuICAgIGlmICghdXBkYXRlUXVldWUuc2l6ZSkge1xuICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiB7XG4gICAgICAgIHdhbGtJblNoYWRvdyhkb2N1bWVudC5ib2R5LCAobm9kZSkgPT4ge1xuICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZS5oYXMobm9kZS5jb25zdHJ1Y3RvcikpIHtcbiAgICAgICAgICAgIGNvbnN0IGh5YnJpZHMgPSB1cGRhdGVRdWV1ZS5nZXQobm9kZS5jb25zdHJ1Y3Rvcik7XG4gICAgICAgICAgICBub2RlLmRpc2Nvbm5lY3RlZENhbGxiYWNrKCk7XG5cbiAgICAgICAgICAgIE9iamVjdC5rZXlzKG5vZGUuY29uc3RydWN0b3IuaHlicmlkcykuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgICAgICAgIGNhY2hlLmludmFsaWRhdGUobm9kZSwga2V5LCBub2RlW2tleV0gPT09IGh5YnJpZHNba2V5XSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbm9kZS5jb25uZWN0ZWRDYWxsYmFjaygpO1xuICAgICAgICAgICAgZGlzcGF0Y2hJbnZhbGlkYXRlKG5vZGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHVwZGF0ZVF1ZXVlLmNsZWFyKCk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgdXBkYXRlUXVldWUuc2V0KEh5YnJpZCwgbGFzdEh5YnJpZHMpO1xuICB9O1xufVxuXG5jb25zdCBjb25uZWN0cyA9IG5ldyBXZWFrTWFwKCk7XG5cbmZ1bmN0aW9uIGRlZmluZUVsZW1lbnQodGFnTmFtZSwgaHlicmlkc09yQ29uc3RydWN0b3IpIHtcbiAgY29uc3QgdHlwZSA9IHR5cGVvZiBoeWJyaWRzT3JDb25zdHJ1Y3RvcjtcbiAgaWYgKHR5cGUgIT09ICdvYmplY3QnICYmIHR5cGUgIT09ICdmdW5jdGlvbicpIHtcbiAgICB0aHJvdyBUeXBlRXJyb3IoYFNlY29uZCBhcmd1bWVudCBtdXN0IGJlIGFuIG9iamVjdCBvciBhIGZ1bmN0aW9uOiAke3R5cGV9YCk7XG4gIH1cblxuICBjb25zdCBDdXN0b21FbGVtZW50ID0gd2luZG93LmN1c3RvbUVsZW1lbnRzLmdldCh0YWdOYW1lKTtcblxuICBpZiAodHlwZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIGlmIChDdXN0b21FbGVtZW50ICE9PSBoeWJyaWRzT3JDb25zdHJ1Y3Rvcikge1xuICAgICAgcmV0dXJuIHdpbmRvdy5jdXN0b21FbGVtZW50cy5kZWZpbmUodGFnTmFtZSwgaHlicmlkc09yQ29uc3RydWN0b3IpO1xuICAgIH1cbiAgICByZXR1cm4gQ3VzdG9tRWxlbWVudDtcbiAgfVxuXG4gIGlmIChDdXN0b21FbGVtZW50KSB7XG4gICAgaWYgKEN1c3RvbUVsZW1lbnQuaHlicmlkcyA9PT0gaHlicmlkc09yQ29uc3RydWN0b3IpIHtcbiAgICAgIHJldHVybiBDdXN0b21FbGVtZW50O1xuICAgIH1cbiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBDdXN0b21FbGVtZW50Lmh5YnJpZHMpIHtcbiAgICAgIE9iamVjdC5rZXlzKEN1c3RvbUVsZW1lbnQuaHlicmlkcykuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgIGRlbGV0ZSBDdXN0b21FbGVtZW50LnByb3RvdHlwZVtrZXldO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGxhc3RIeWJyaWRzID0gQ3VzdG9tRWxlbWVudC5oeWJyaWRzO1xuXG4gICAgICBjb21waWxlKEN1c3RvbUVsZW1lbnQsIGh5YnJpZHNPckNvbnN0cnVjdG9yKTtcbiAgICAgIHVwZGF0ZShDdXN0b21FbGVtZW50LCBsYXN0SHlicmlkcyk7XG5cbiAgICAgIHJldHVybiBDdXN0b21FbGVtZW50O1xuICAgIH1cblxuICAgIHRocm93IEVycm9yKGBFbGVtZW50ICcke3RhZ05hbWV9JyBhbHJlYWR5IGRlZmluZWRgKTtcbiAgfVxuXG4gIGNsYXNzIEh5YnJpZCBleHRlbmRzIEhUTUxFbGVtZW50IHtcbiAgICBzdGF0aWMgZ2V0IG5hbWUoKSB7IHJldHVybiB0YWdOYW1lOyB9XG5cbiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHtcbiAgICAgIGNvbnN0IGxpc3QgPSB0aGlzLmNvbnN0cnVjdG9yLmNvbm5lY3RzLnJlZHVjZSgoYWNjLCBmbikgPT4ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBmbih0aGlzKTtcbiAgICAgICAgaWYgKHJlc3VsdCkgYWNjLmFkZChyZXN1bHQpO1xuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSwgbmV3IFNldCgpKTtcblxuICAgICAgY29ubmVjdHMuc2V0KHRoaXMsIGxpc3QpO1xuICAgICAgZGlzcGF0Y2hJbnZhbGlkYXRlKHRoaXMpO1xuICAgIH1cblxuICAgIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkge1xuICAgICAgY29uc3QgbGlzdCA9IGNvbm5lY3RzLmdldCh0aGlzKTtcbiAgICAgIGxpc3QuZm9yRWFjaChmbiA9PiBmbigpKTtcbiAgICB9XG4gIH1cblxuICBjb21waWxlKEh5YnJpZCwgaHlicmlkc09yQ29uc3RydWN0b3IpO1xuICBjdXN0b21FbGVtZW50cy5kZWZpbmUodGFnTmFtZSwgSHlicmlkKTtcblxuICByZXR1cm4gSHlicmlkO1xufVxuXG5mdW5jdGlvbiBkZWZpbmVNYXAoZWxlbWVudHMpIHtcbiAgcmV0dXJuIE9iamVjdC5rZXlzKGVsZW1lbnRzKS5yZWR1Y2UoKGFjYywga2V5KSA9PiB7XG4gICAgY29uc3QgdGFnTmFtZSA9IHBhc2NhbFRvRGFzaChrZXkpO1xuICAgIGFjY1trZXldID0gZGVmaW5lRWxlbWVudCh0YWdOYW1lLCBlbGVtZW50c1trZXldKTtcblxuICAgIHJldHVybiBhY2M7XG4gIH0sIHt9KTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gZGVmaW5lKC4uLmFyZ3MpIHtcbiAgaWYgKHR5cGVvZiBhcmdzWzBdID09PSAnb2JqZWN0Jykge1xuICAgIHJldHVybiBkZWZpbmVNYXAoYXJnc1swXSk7XG4gIH1cblxuICByZXR1cm4gZGVmaW5lRWxlbWVudCguLi5hcmdzKTtcbn1cbiJdfQ==