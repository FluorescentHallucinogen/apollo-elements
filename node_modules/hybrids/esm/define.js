function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === "object" || typeof call === "function")) { return call; } return _assertThisInitialized(self); }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }

function _wrapNativeSuper(Class) { var _cache = typeof Map === "function" ? new Map() : undefined; _wrapNativeSuper = function _wrapNativeSuper(Class) { if (Class === null || !_isNativeFunction(Class)) return Class; if (typeof Class !== "function") { throw new TypeError("Super expression must either be null or a function"); } if (typeof _cache !== "undefined") { if (_cache.has(Class)) return _cache.get(Class); _cache.set(Class, Wrapper); } function Wrapper() { return _construct(Class, arguments, _getPrototypeOf(this).constructor); } Wrapper.prototype = Object.create(Class.prototype, { constructor: { value: Wrapper, enumerable: false, writable: true, configurable: true } }); return _setPrototypeOf(Wrapper, Class); }; return _wrapNativeSuper(Class); }

function isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }

function _construct(Parent, args, Class) { if (isNativeReflectConstruct()) { _construct = Reflect.construct; } else { _construct = function _construct(Parent, args, Class) { var a = [null]; a.push.apply(a, args); var Constructor = Function.bind.apply(Parent, a); var instance = new Constructor(); if (Class) _setPrototypeOf(instance, Class.prototype); return instance; }; } return _construct.apply(null, arguments); }

function _isNativeFunction(fn) { return Function.toString.call(fn).indexOf("[native code]") !== -1; }

function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }

function _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

import property from './property';
import render from './render';
import * as cache from './cache';
import { dispatch, pascalToDash } from './utils';
/* istanbul ignore next */

try {
  process.env.NODE_ENV;
} catch (e) {
  var process = {
    env: {
      NODE_ENV: 'production'
    }
  };
} // eslint-disable-line


function dispatchInvalidate(host) {
  dispatch(host, '@invalidate', {
    bubbles: true,
    composed: true
  });
}

var defaultMethod = function defaultMethod(host, value) {
  return value;
};

function compile(Hybrid, hybrids) {
  Hybrid.hybrids = hybrids;
  Hybrid.connects = [];
  Object.keys(hybrids).forEach(function (key) {
    var value = hybrids[key];

    var type = _typeof(value);

    var config;

    if (type === 'function') {
      config = key === 'render' ? render(value) : {
        get: value
      };
    } else if (value === null || type !== 'object' || type === 'object' && !value.get && !value.set && !value.connect) {
      config = property(value);
    } else {
      config = {
        get: value.get || defaultMethod,
        set: value.set || !value.get && defaultMethod || undefined,
        connect: value.connect
      };
    }

    Object.defineProperty(Hybrid.prototype, key, {
      get: function get() {
        return cache.get(this, key, config.get);
      },
      set: config.set && function set(newValue) {
        var _this = this;

        cache.set(this, key, config.set, newValue, function () {
          return dispatchInvalidate(_this);
        });
      },
      enumerable: true,
      configurable: process.env.NODE_ENV !== 'production'
    });

    if (config.connect) {
      Hybrid.connects.push(function (host) {
        return config.connect(host, key, function () {
          var clearCache = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;
          if (clearCache) cache.invalidate(host, key);
          dispatchInvalidate(host);
        });
      });
    }
  });
}

var update;
/* istanbul ignore else */

if (process.env.NODE_ENV !== 'production') {
  var walkInShadow = function walkInShadow(node, fn) {
    fn(node);
    Array.from(node.children).forEach(function (el) {
      return walkInShadow(el, fn);
    });

    if (node.shadowRoot) {
      Array.from(node.shadowRoot.children).forEach(function (el) {
        return walkInShadow(el, fn);
      });
    }
  };

  var updateQueue = new Map();

  update = function update(Hybrid, lastHybrids) {
    if (!updateQueue.size) {
      Promise.resolve().then(function () {
        walkInShadow(document.body, function (node) {
          if (updateQueue.has(node.constructor)) {
            var hybrids = updateQueue.get(node.constructor);
            node.disconnectedCallback();
            Object.keys(node.constructor.hybrids).forEach(function (key) {
              cache.invalidate(node, key, node[key] === hybrids[key]);
            });
            node.connectedCallback();
            dispatchInvalidate(node);
          }
        });
        updateQueue.clear();
      });
    }

    updateQueue.set(Hybrid, lastHybrids);
  };
}

var connects = new WeakMap();

function defineElement(tagName, hybridsOrConstructor) {
  var type = _typeof(hybridsOrConstructor);

  if (type !== 'object' && type !== 'function') {
    throw TypeError("Second argument must be an object or a function: ".concat(type));
  }

  var CustomElement = window.customElements.get(tagName);

  if (type === 'function') {
    if (CustomElement !== hybridsOrConstructor) {
      return window.customElements.define(tagName, hybridsOrConstructor);
    }

    return CustomElement;
  }

  if (CustomElement) {
    if (CustomElement.hybrids === hybridsOrConstructor) {
      return CustomElement;
    }

    if (process.env.NODE_ENV !== 'production' && CustomElement.hybrids) {
      Object.keys(CustomElement.hybrids).forEach(function (key) {
        delete CustomElement.prototype[key];
      });
      var lastHybrids = CustomElement.hybrids;
      compile(CustomElement, hybridsOrConstructor);
      update(CustomElement, lastHybrids);
      return CustomElement;
    }

    throw Error("Element '".concat(tagName, "' already defined"));
  }

  var Hybrid =
  /*#__PURE__*/
  function (_HTMLElement) {
    _inherits(Hybrid, _HTMLElement);

    function Hybrid() {
      _classCallCheck(this, Hybrid);

      return _possibleConstructorReturn(this, _getPrototypeOf(Hybrid).apply(this, arguments));
    }

    _createClass(Hybrid, [{
      key: "connectedCallback",
      value: function connectedCallback() {
        var _this2 = this;

        var list = this.constructor.connects.reduce(function (acc, fn) {
          var result = fn(_this2);
          if (result) acc.add(result);
          return acc;
        }, new Set());
        connects.set(this, list);
        dispatchInvalidate(this);
      }
    }, {
      key: "disconnectedCallback",
      value: function disconnectedCallback() {
        var list = connects.get(this);
        list.forEach(function (fn) {
          return fn();
        });
      }
    }], [{
      key: "name",
      get: function get() {
        return tagName;
      }
    }]);

    return Hybrid;
  }(_wrapNativeSuper(HTMLElement));

  compile(Hybrid, hybridsOrConstructor);
  customElements.define(tagName, Hybrid);
  return Hybrid;
}

function defineMap(elements) {
  return Object.keys(elements).reduce(function (acc, key) {
    var tagName = pascalToDash(key);
    acc[key] = defineElement(tagName, elements[key]);
    return acc;
  }, {});
}

export default function define() {
  if (_typeof(arguments.length <= 0 ? undefined : arguments[0]) === 'object') {
    return defineMap(arguments.length <= 0 ? undefined : arguments[0]);
  }

  return defineElement.apply(void 0, arguments);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9kZWZpbmUuanMiXSwibmFtZXMiOlsicHJvcGVydHkiLCJyZW5kZXIiLCJjYWNoZSIsImRpc3BhdGNoIiwicGFzY2FsVG9EYXNoIiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwiZSIsImRpc3BhdGNoSW52YWxpZGF0ZSIsImhvc3QiLCJidWJibGVzIiwiY29tcG9zZWQiLCJkZWZhdWx0TWV0aG9kIiwidmFsdWUiLCJjb21waWxlIiwiSHlicmlkIiwiaHlicmlkcyIsImNvbm5lY3RzIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrZXkiLCJ0eXBlIiwiY29uZmlnIiwiZ2V0Iiwic2V0IiwiY29ubmVjdCIsInVuZGVmaW5lZCIsImRlZmluZVByb3BlcnR5IiwicHJvdG90eXBlIiwibmV3VmFsdWUiLCJlbnVtZXJhYmxlIiwiY29uZmlndXJhYmxlIiwicHVzaCIsImNsZWFyQ2FjaGUiLCJpbnZhbGlkYXRlIiwidXBkYXRlIiwid2Fsa0luU2hhZG93Iiwibm9kZSIsImZuIiwiQXJyYXkiLCJmcm9tIiwiY2hpbGRyZW4iLCJlbCIsInNoYWRvd1Jvb3QiLCJ1cGRhdGVRdWV1ZSIsIk1hcCIsImxhc3RIeWJyaWRzIiwic2l6ZSIsIlByb21pc2UiLCJyZXNvbHZlIiwidGhlbiIsImRvY3VtZW50IiwiYm9keSIsImhhcyIsImNvbnN0cnVjdG9yIiwiZGlzY29ubmVjdGVkQ2FsbGJhY2siLCJjb25uZWN0ZWRDYWxsYmFjayIsImNsZWFyIiwiV2Vha01hcCIsImRlZmluZUVsZW1lbnQiLCJ0YWdOYW1lIiwiaHlicmlkc09yQ29uc3RydWN0b3IiLCJUeXBlRXJyb3IiLCJDdXN0b21FbGVtZW50Iiwid2luZG93IiwiY3VzdG9tRWxlbWVudHMiLCJkZWZpbmUiLCJFcnJvciIsImxpc3QiLCJyZWR1Y2UiLCJhY2MiLCJyZXN1bHQiLCJhZGQiLCJTZXQiLCJIVE1MRWxlbWVudCIsImRlZmluZU1hcCIsImVsZW1lbnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7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Q0FBQ0MsTUFBRCxFQUFTK0Msb0JBQVQsQ0FBUDtBQUNBSSxFQUFBQSxjQUFjLENBQUNDLE1BQWYsQ0FBc0JOLE9BQXRCLEVBQStCOUMsTUFBL0I7QUFFQSxTQUFPQSxNQUFQO0FBQ0Q7O0FBRUQsU0FBUzZELFNBQVQsQ0FBbUJDLFFBQW5CLEVBQTZCO0FBQzNCLFNBQU8zRCxNQUFNLENBQUNDLElBQVAsQ0FBWTBELFFBQVosRUFBc0JQLE1BQXRCLENBQTZCLFVBQUNDLEdBQUQsRUFBTWxELEdBQU4sRUFBYztBQUNoRCxRQUFNd0MsT0FBTyxHQUFHMUQsWUFBWSxDQUFDa0IsR0FBRCxDQUE1QjtBQUNBa0QsSUFBQUEsR0FBRyxDQUFDbEQsR0FBRCxDQUFILEdBQVd1QyxhQUFhLENBQUNDLE9BQUQsRUFBVWdCLFFBQVEsQ0FBQ3hELEdBQUQsQ0FBbEIsQ0FBeEI7QUFFQSxXQUFPa0QsR0FBUDtBQUNELEdBTE0sRUFLSixFQUxJLENBQVA7QUFNRDs7QUFFRCxlQUFlLFNBQVNKLE1BQVQsR0FBeUI7QUFDdEMsTUFBSSw4REFBbUIsUUFBdkIsRUFBaUM7QUFDL0IsV0FBT1MsU0FBUyxrREFBaEI7QUFDRDs7QUFFRCxTQUFPaEIsYUFBYSxNQUFiLG1CQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcHJvcGVydHkgZnJvbSAnLi9wcm9wZXJ0eSc7XG5pbXBvcnQgcmVuZGVyIGZyb20gJy4vcmVuZGVyJztcblxuaW1wb3J0ICogYXMgY2FjaGUgZnJvbSAnLi9jYWNoZSc7XG5pbXBvcnQgeyBkaXNwYXRjaCwgcGFzY2FsVG9EYXNoIH0gZnJvbSAnLi91dGlscyc7XG5cbi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG50cnkgeyBwcm9jZXNzLmVudi5OT0RFX0VOViB9IGNhdGNoKGUpIHsgdmFyIHByb2Nlc3MgPSB7IGVudjogeyBOT0RFX0VOVjogJ3Byb2R1Y3Rpb24nIH0gfTsgfSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG5cbmZ1bmN0aW9uIGRpc3BhdGNoSW52YWxpZGF0ZShob3N0KSB7XG4gIGRpc3BhdGNoKGhvc3QsICdAaW52YWxpZGF0ZScsIHsgYnViYmxlczogdHJ1ZSwgY29tcG9zZWQ6IHRydWUgfSk7XG59XG5cbmNvbnN0IGRlZmF1bHRNZXRob2QgPSAoaG9zdCwgdmFsdWUpID0+IHZhbHVlO1xuXG5mdW5jdGlvbiBjb21waWxlKEh5YnJpZCwgaHlicmlkcykge1xuICBIeWJyaWQuaHlicmlkcyA9IGh5YnJpZHM7XG4gIEh5YnJpZC5jb25uZWN0cyA9IFtdO1xuXG4gIE9iamVjdC5rZXlzKGh5YnJpZHMpLmZvckVhY2goKGtleSkgPT4ge1xuICAgIGNvbnN0IHZhbHVlID0gaHlicmlkc1trZXldO1xuICAgIGNvbnN0IHR5cGUgPSB0eXBlb2YgdmFsdWU7XG5cbiAgICBsZXQgY29uZmlnO1xuXG4gICAgaWYgKHR5cGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGNvbmZpZyA9IGtleSA9PT0gJ3JlbmRlcicgPyByZW5kZXIodmFsdWUpIDogeyBnZXQ6IHZhbHVlIH07XG4gICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlICE9PSAnb2JqZWN0JyB8fCAodHlwZSA9PT0gJ29iamVjdCcgJiYgIXZhbHVlLmdldCAmJiAhdmFsdWUuc2V0ICYmICF2YWx1ZS5jb25uZWN0KSkge1xuICAgICAgY29uZmlnID0gcHJvcGVydHkodmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25maWcgPSB7XG4gICAgICAgIGdldDogdmFsdWUuZ2V0IHx8IGRlZmF1bHRNZXRob2QsXG4gICAgICAgIHNldDogdmFsdWUuc2V0IHx8ICghdmFsdWUuZ2V0ICYmIGRlZmF1bHRNZXRob2QpIHx8IHVuZGVmaW5lZCxcbiAgICAgICAgY29ubmVjdDogdmFsdWUuY29ubmVjdCxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEh5YnJpZC5wcm90b3R5cGUsIGtleSwge1xuICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7XG4gICAgICAgIHJldHVybiBjYWNoZS5nZXQodGhpcywga2V5LCBjb25maWcuZ2V0KTtcbiAgICAgIH0sXG4gICAgICBzZXQ6IGNvbmZpZy5zZXQgJiYgZnVuY3Rpb24gc2V0KG5ld1ZhbHVlKSB7XG4gICAgICAgIGNhY2hlLnNldCh0aGlzLCBrZXksIGNvbmZpZy5zZXQsIG5ld1ZhbHVlLCAoKSA9PiBkaXNwYXRjaEludmFsaWRhdGUodGhpcykpO1xuICAgICAgfSxcbiAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICBjb25maWd1cmFibGU6IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicsXG4gICAgfSk7XG5cbiAgICBpZiAoY29uZmlnLmNvbm5lY3QpIHtcbiAgICAgIEh5YnJpZC5jb25uZWN0cy5wdXNoKGhvc3QgPT4gY29uZmlnLmNvbm5lY3QoaG9zdCwga2V5LCAoY2xlYXJDYWNoZSA9IHRydWUpID0+IHtcbiAgICAgICAgaWYgKGNsZWFyQ2FjaGUpIGNhY2hlLmludmFsaWRhdGUoaG9zdCwga2V5KTtcbiAgICAgICAgZGlzcGF0Y2hJbnZhbGlkYXRlKGhvc3QpO1xuICAgICAgfSkpO1xuICAgIH1cbiAgfSk7XG59XG5cbmxldCB1cGRhdGU7XG4vKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqL1xuaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHtcbiAgY29uc3Qgd2Fsa0luU2hhZG93ID0gKG5vZGUsIGZuKSA9PiB7XG4gICAgZm4obm9kZSk7XG5cbiAgICBBcnJheS5mcm9tKG5vZGUuY2hpbGRyZW4pXG4gICAgICAuZm9yRWFjaChlbCA9PiB3YWxrSW5TaGFkb3coZWwsIGZuKSk7XG5cbiAgICBpZiAobm9kZS5zaGFkb3dSb290KSB7XG4gICAgICBBcnJheS5mcm9tKG5vZGUuc2hhZG93Um9vdC5jaGlsZHJlbilcbiAgICAgICAgLmZvckVhY2goZWwgPT4gd2Fsa0luU2hhZG93KGVsLCBmbikpO1xuICAgIH1cbiAgfTtcblxuICBjb25zdCB1cGRhdGVRdWV1ZSA9IG5ldyBNYXAoKTtcbiAgdXBkYXRlID0gKEh5YnJpZCwgbGFzdEh5YnJpZHMpID0+IHtcbiAgICBpZiAoIXVwZGF0ZVF1ZXVlLnNpemUpIHtcbiAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICB3YWxrSW5TaGFkb3coZG9jdW1lbnQuYm9keSwgKG5vZGUpID0+IHtcbiAgICAgICAgICBpZiAodXBkYXRlUXVldWUuaGFzKG5vZGUuY29uc3RydWN0b3IpKSB7XG4gICAgICAgICAgICBjb25zdCBoeWJyaWRzID0gdXBkYXRlUXVldWUuZ2V0KG5vZGUuY29uc3RydWN0b3IpO1xuICAgICAgICAgICAgbm9kZS5kaXNjb25uZWN0ZWRDYWxsYmFjaygpO1xuXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhub2RlLmNvbnN0cnVjdG9yLmh5YnJpZHMpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICAgICAgICBjYWNoZS5pbnZhbGlkYXRlKG5vZGUsIGtleSwgbm9kZVtrZXldID09PSBoeWJyaWRzW2tleV0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG5vZGUuY29ubmVjdGVkQ2FsbGJhY2soKTtcbiAgICAgICAgICAgIGRpc3BhdGNoSW52YWxpZGF0ZShub2RlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB1cGRhdGVRdWV1ZS5jbGVhcigpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHVwZGF0ZVF1ZXVlLnNldChIeWJyaWQsIGxhc3RIeWJyaWRzKTtcbiAgfTtcbn1cblxuY29uc3QgY29ubmVjdHMgPSBuZXcgV2Vha01hcCgpO1xuXG5mdW5jdGlvbiBkZWZpbmVFbGVtZW50KHRhZ05hbWUsIGh5YnJpZHNPckNvbnN0cnVjdG9yKSB7XG4gIGNvbnN0IHR5cGUgPSB0eXBlb2YgaHlicmlkc09yQ29uc3RydWN0b3I7XG4gIGlmICh0eXBlICE9PSAnb2JqZWN0JyAmJiB0eXBlICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgdGhyb3cgVHlwZUVycm9yKGBTZWNvbmQgYXJndW1lbnQgbXVzdCBiZSBhbiBvYmplY3Qgb3IgYSBmdW5jdGlvbjogJHt0eXBlfWApO1xuICB9XG5cbiAgY29uc3QgQ3VzdG9tRWxlbWVudCA9IHdpbmRvdy5jdXN0b21FbGVtZW50cy5nZXQodGFnTmFtZSk7XG5cbiAgaWYgKHR5cGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICBpZiAoQ3VzdG9tRWxlbWVudCAhPT0gaHlicmlkc09yQ29uc3RydWN0b3IpIHtcbiAgICAgIHJldHVybiB3aW5kb3cuY3VzdG9tRWxlbWVudHMuZGVmaW5lKHRhZ05hbWUsIGh5YnJpZHNPckNvbnN0cnVjdG9yKTtcbiAgICB9XG4gICAgcmV0dXJuIEN1c3RvbUVsZW1lbnQ7XG4gIH1cblxuICBpZiAoQ3VzdG9tRWxlbWVudCkge1xuICAgIGlmIChDdXN0b21FbGVtZW50Lmh5YnJpZHMgPT09IGh5YnJpZHNPckNvbnN0cnVjdG9yKSB7XG4gICAgICByZXR1cm4gQ3VzdG9tRWxlbWVudDtcbiAgICB9XG4gICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgQ3VzdG9tRWxlbWVudC5oeWJyaWRzKSB7XG4gICAgICBPYmplY3Qua2V5cyhDdXN0b21FbGVtZW50Lmh5YnJpZHMpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICBkZWxldGUgQ3VzdG9tRWxlbWVudC5wcm90b3R5cGVba2V5XTtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBsYXN0SHlicmlkcyA9IEN1c3RvbUVsZW1lbnQuaHlicmlkcztcblxuICAgICAgY29tcGlsZShDdXN0b21FbGVtZW50LCBoeWJyaWRzT3JDb25zdHJ1Y3Rvcik7XG4gICAgICB1cGRhdGUoQ3VzdG9tRWxlbWVudCwgbGFzdEh5YnJpZHMpO1xuXG4gICAgICByZXR1cm4gQ3VzdG9tRWxlbWVudDtcbiAgICB9XG5cbiAgICB0aHJvdyBFcnJvcihgRWxlbWVudCAnJHt0YWdOYW1lfScgYWxyZWFkeSBkZWZpbmVkYCk7XG4gIH1cblxuICBjbGFzcyBIeWJyaWQgZXh0ZW5kcyBIVE1MRWxlbWVudCB7XG4gICAgc3RhdGljIGdldCBuYW1lKCkgeyByZXR1cm4gdGFnTmFtZTsgfVxuXG4gICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgICBjb25zdCBsaXN0ID0gdGhpcy5jb25zdHJ1Y3Rvci5jb25uZWN0cy5yZWR1Y2UoKGFjYywgZm4pID0+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gZm4odGhpcyk7XG4gICAgICAgIGlmIChyZXN1bHQpIGFjYy5hZGQocmVzdWx0KTtcbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sIG5ldyBTZXQoKSk7XG5cbiAgICAgIGNvbm5lY3RzLnNldCh0aGlzLCBsaXN0KTtcbiAgICAgIGRpc3BhdGNoSW52YWxpZGF0ZSh0aGlzKTtcbiAgICB9XG5cbiAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHtcbiAgICAgIGNvbnN0IGxpc3QgPSBjb25uZWN0cy5nZXQodGhpcyk7XG4gICAgICBsaXN0LmZvckVhY2goZm4gPT4gZm4oKSk7XG4gICAgfVxuICB9XG5cbiAgY29tcGlsZShIeWJyaWQsIGh5YnJpZHNPckNvbnN0cnVjdG9yKTtcbiAgY3VzdG9tRWxlbWVudHMuZGVmaW5lKHRhZ05hbWUsIEh5YnJpZCk7XG5cbiAgcmV0dXJuIEh5YnJpZDtcbn1cblxuZnVuY3Rpb24gZGVmaW5lTWFwKGVsZW1lbnRzKSB7XG4gIHJldHVybiBPYmplY3Qua2V5cyhlbGVtZW50cykucmVkdWNlKChhY2MsIGtleSkgPT4ge1xuICAgIGNvbnN0IHRhZ05hbWUgPSBwYXNjYWxUb0Rhc2goa2V5KTtcbiAgICBhY2Nba2V5XSA9IGRlZmluZUVsZW1lbnQodGFnTmFtZSwgZWxlbWVudHNba2V5XSk7XG5cbiAgICByZXR1cm4gYWNjO1xuICB9LCB7fSk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGRlZmluZSguLi5hcmdzKSB7XG4gIGlmICh0eXBlb2YgYXJnc1swXSA9PT0gJ29iamVjdCcpIHtcbiAgICByZXR1cm4gZGVmaW5lTWFwKGFyZ3NbMF0pO1xuICB9XG5cbiAgcmV0dXJuIGRlZmluZUVsZW1lbnQoLi4uYXJncyk7XG59XG4iXX0=